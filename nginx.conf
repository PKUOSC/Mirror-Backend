server {
    return 403;
}

server {
    listen	3001;
    root /data/repos/;
    location /ubuntu-releases/ {
        autoindex on;
	autoindex_format json;
    }
    location /ubuntu-cdimages/ {
        autoindex on;
	autoindex_format json;
    }
    location /ubuntu/ {
        autoindex on;
	autoindex_format json;
    }
    location /centos/ {
        autoindex on;
	autoindex_format json;
    }
    location /manjaro/ {
        autoindex on;
	autoindex_format json;
    }
    location /epel/ {
        autoindex on;
	autoindex_format json;
    }
    location /archlinux/ {
        autoindex on;
	autoindex_format json;
    }
    location /archlinuxarm/ {
        autoindex on;
	autoindex_format json;
    }
    location /linuxmint/ {
        autoindex on;
	autoindex_format json;
    }
    location /linuxmint-cdimages/ {
        autoindex on;
	autoindex_format json;
    }
    location /opensuse/ {
        autoindex on;
        autoindex_format json;
    }
    location /anaconda/ {
        autoindex on;
        autoindex_format json;
    }
    location /pypi/ {
        autoindex on;
	autoindex_format json;
        alias /data/repos/pypi/web/;
    }
    location /gentoo/ {
        autoindex on;
        autoindex_format json;
    }
    location /debian/ {
        autoindex on;
        autoindex_format json;
    }
    location /debian-cd/ {
        autoindex on;
        autoindex_format json;
    }
    location /huggingface/ {
        autoindex on;
        autoindex_format json;
    }
}

server {
    listen       80;
    listen       [::]:80;
    listen       443 ssl;
    listen       [::]:443 ssl;
    server_name  mirrors.pku.edu.cn;

    # return 301 https://$server_name$request_uri;

    error_log    /var/log/nginx/repos_test_error.log;
    access_log   /var/log/nginx/repos_test_access.log;

    root /data/repos/;

    location /phpmyadmin/ {
        # proxy_pass http://localhost:3002/;
	root /data/;
	index index.php index.html;
    }

    # XXX: Is it better to put those into /repos?
    location /static/ {
        root /data/web/dist/;
        gzip_static on;
    }
    location /repoconfig/ {
        root /data/web/;
    }

    location /monitor/ {
        proxy_pass http://localhost:3000/;
    }
    location /files/ {
	proxy_pass http://localhost:3001/;
    }
    location = /robots.txt {
        root /data/web/repoconfig/;
    }
    location = /google53f21eaac539b6a8.html {
        root /data/web/repoconfig/;
    }
    location = /baidu_verify_code-E12Mj7SzYn.html {
        root /data/web/repoconfig/;
    }

    location /monitor_device/ {
	proxy_pass http://127.0.0.1:19999/;
    }

# Web router
    location = /index.html {
    	root /data/web/dist;
    }
    location = /Mirrors {
    	root /data/web/dist/;
	rewrite ^ /index.html break;
    }
    location /Mirrors/ {
    	root /data/web/dist/;
    	rewrite ^ /index.html break;
    }
    location = /Status {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location /Status/ {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location = /Help {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location /Help/ {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location = /About {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location /About/ {
        root /data/web/dist/;
        rewrite ^ /index.html break;
    }
    location = /Error404 {
        root /data/web/dist/;
	error_page 404 /index.html;
        return 404;
    }
    location = / {
	root /data/web/dist/;
	rewrite ^ /index.html break;
    }
    location /pypi/ {
	alias /data/repos/pypi/web/;
        if (!-e $request_filename) {
            root /data/web/dist/;
            error_page 404 /index.html;
            return 404;
        }
        try_files $uri $uri/index.html @frontend;
    }
    location / {
	if (!-e $request_filename) {
	    root /data/web/dist/;
	    error_page 404 /index.html;
	    return 404;
	}
	try_files $uri @frontend;
    }
    location @error {
	root /data/web/dist/;
	error_page 404 /index.html;
	return 404;
    }
    location @frontend {
	root /data/web/dist;
	rewrite ^ /index.html break;
    }
    # PHP
    location ~ \.php$ {
        fastcgi_pass   unix:/var/run/php-fpm/www.sock;
	fastcgi_index  index.php;
	fastcgi_param  SCRIPT_FILENAME /data/$fastcgi_script_name;
	include        fastcgi_params;
	fastcgi_param   SCRIPT_NAME $fastcgi_script_name;
    }

    # Managed by Certbot
    ssl_certificate /etc/letsencrypt/live/mirrors.pku.edu.cn/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/mirrors.pku.edu.cn/privkey.pem;
    include /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem;
}
